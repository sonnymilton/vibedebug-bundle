{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        #md-exception-description-textarea {
            width: 100%;
            height: 400px
        }

        .btn {
            color: inherit;
            background-color: transparent;
            padding: 6px 12px;
        }

        #ai-response {
            display: none;
        }

        .ai-response-pre {
            white-space: pre-wrap;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        #ai-response-loader > svg {
            animation: spin 1s infinite linear;
        }
    </style>
{% endblock %}

{% block javascripts %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const copyButton = document.getElementById('copy-md-button');
            const mdTextArea = document.getElementById('md-exception-description-textarea');

            copyButton.addEventListener('click', async () => await navigator.clipboard.writeText(mdTextArea.value))

            const aiResponseSection = document.getElementById('ai-response');

            for (const button of document.getElementsByClassName('js-ask-agent-btn')) {
                button.addEventListener('click', async (e) => {
                    aiResponseSection.style.display = 'block';

                    const button = e.target;

                    fetch(button.dataset.url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: mdTextArea.value,
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            const aiResponse = document.createElement('pre');
                            aiResponse.textContent = data.result;
                            aiResponse.classList.add('ai-response-pre');

                            document.getElementById('ai-response-loader').replaceWith(aiResponse);
                        })
                    ;

                    button.remove();
                })
            }
        })
    </script>
{% endblock %}

{% block toolbar %}
    {% set icon %}
        {% include '@Vibedebug/icon/bug.svg' %}
    {% endset %}

    {% set text %}
        {% if collector.exception %}
            <div class="sf-toolbar-info-piece">
                 <pre id="sf-toolbar-vibedebug-md-description">
                    {%- include '@Vibedebug/data_collector/prompt.md.twig' with {exception: collector.exception } -%}
                </pre>
                <button
                    style="background-color: transparent;"
                    onclick="navigator.clipboard.writeText(document.getElementById('sf-toolbar-vibedebug-md-description').textContent)"
                >Copy prompt</button>
            </div>
        {% endif %}
    {% endset %}

    {% if collector.exception %}
        {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', { 'link': true }) }}
    {% endif %}
{% endblock %}

{% block menu %}
    <span class="label">
        {% include '@Vibedebug/icon/bug.svg' %}
        <strong>Vibedebug</strong>
    </span>
{% endblock %}

{% block panel %}
    <h2>Vibedebugging</h2>

    {% if collector.exception %}
        <textarea id="md-exception-description-textarea">
                {%- include '@Vibedebug/data_collector/prompt.md.twig' with { exception: collector.exception } -%}
        </textarea>

        <button id="copy-md-button" class="btn">Copy prompt</button>

        {% for agent in collector.agents %}
            <button
                    class="btn js-ask-agent-btn"
                    data-url="{{ path('vibedebug_ask_agent', {agent: agent}) }}"
                    data-agent="{{ agent }}">
                Ask {{ agent }}
            </button>
        {% endfor %}

        <div id="ai-response">
            <h3>AI response:</h3>
            <div id="ai-response-loader">{% include '@Vibedebug/icon/load.svg' %}</div>
        </div>
    {% else %}
        <strong>Nothing to debug. Your app is running fine.</strong>
    {% endif %}
{% endblock %}
